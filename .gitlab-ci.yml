stages:
  - build
  - build-docker

build-nginx-docker:
  stage: build
  before_script:
    - cd nginx-config
    - export VERSION=$(cat version.txt)
    - docker login -u martenls -p $DOCKER_REGISTRY_TOKEN $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY/martenls/bachelor-thesis-code/nginx-openbot:$VERSION -t $CI_REGISTRY/martenls/bachelor-thesis-code/nginx-openbot .
    - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/nginx-openbot
    - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/nginx-openbot:$VERSION
  after_script:
    - docker logout $CI_REGISTRY
  tags:
    - shared
  only:
    changes:
      - nginx-config/version.txt

# build-twitter-docker:
#   stage: build-docker
#   before_script:
#     - cd sninterface-twitter
#     - export VERSION=$(cat version.txt)
#     - docker login -u martenls -p $DOCKER_REGISTRY_TOKEN $CI_REGISTRY
#   script:
#     - docker build -t $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-twitter:$VERSION -t $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-twitter .
#     - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-twitter
#     - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-twitter:$VERSION
#   after_script:
#     - docker logout $CI_REGISTRY
#   tags:
#     - shared
#   only:
#     changes:
#       - sninterface-twitter/version.txt


build-qasystem:
  stage: build
  image: maven:latest
  before_script:
    - cd qa-system
  script:
    - mvn package
  artifacts:
    paths:
      - qa-system/target/qa-system-0.0.1-SNAPSHOT.jar
  tags:
    - shared


build-qasystem-docker:
  stage: build-docker
  needs:
    - job: build-qasystem
      artifacts: true
  before_script:
    - cd qa-system
    - export VERSION=$(cat version.txt)
    - docker login -u martenls -p $DOCKER_REGISTRY_TOKEN $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY/martenls/bachelor-thesis-code/qa-system:$VERSION -t $CI_REGISTRY/martenls/bachelor-thesis-code/qa-system .
    - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/qa-system
    - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/qa-system:$VERSION
  after_script:
    - docker logout $CI_REGISTRY
  tags:
    - shared

build-sninterface-botkit-twitter-docker:
  stage: build
  before_script:
    - cd sninterface-botkit
    - export VERSION=$(cat version.txt)
    - docker login -u martenls -p $DOCKER_REGISTRY_TOKEN $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-botkit-twitter:$VERSION -t $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-botkit-twitter --file twitter.Dockerfile .
    - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-botkit-twitter
    - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-botkit-twitter:$VERSION
  after_script:
    - docker logout $CI_REGISTRY
  tags:
    - shared

build-sninterface-botkit-web-docker:
  stage: build
  before_script:
    - cd sninterface-botkit
    - export VERSION=$(cat version.txt)
    - docker login -u martenls -p $DOCKER_REGISTRY_TOKEN $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-botkit-web:$VERSION -t $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-botkit-web --file web.Dockerfile .
    - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-botkit-web
    - docker push $CI_REGISTRY/martenls/bachelor-thesis-code/sninterface-botkit-web:$VERSION
  after_script:
    - docker logout $CI_REGISTRY
  tags:
    - shared